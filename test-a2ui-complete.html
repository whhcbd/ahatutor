<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>A2UI åŠŸèƒ½å®Œæ•´æ€§æµ‹è¯•</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 1200px;
      margin: 20px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .test-section {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h1 { color: #333; }
    h2 { color: #666; margin-top: 0; }
    .test-item {
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 15px;
      margin-bottom: 15px;
      background: #fafafa;
    }
    .test-item.success { border-left: 4px solid #4CAF50; }
    .test-item.error { border-left: 4px solid #f44336; }
    .test-item.pending { border-left: 4px solid #FF9800; }
    .test-title { font-weight: bold; margin-bottom: 10px; }
    .test-result { margin-top: 10px; padding: 10px; border-radius: 4px; }
    .test-result.success { background: #E8F5E9; color: #2E7D32; }
    .test-result.error { background: #FFEBEE; color: #C62828; }
    .test-result.info { background: #E3F2FD; color: #1565C0; }
    button {
      background: #2196F3;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 10px;
    }
    button:hover { background: #1976D2; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    .log-output {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 15px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      max-height: 300px;
      overflow-y: auto;
      white-space: pre-wrap;
    }
    .stream-output {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      padding: 10px;
      margin-top: 10px;
      border-radius: 4px;
    }
    .chunk {
      padding: 5px;
      margin: 5px 0;
      border-left: 3px solid #2196F3;
      background: white;
    }
    .chunk-type {
      font-weight: bold;
      color: #1976D2;
    }
    .progress-bar {
      width: 100%;
      height: 20px;
      background: #e0e0e0;
      border-radius: 10px;
      overflow: hidden;
      margin: 10px 0;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #2196F3, #4CAF50);
      transition: width 0.3s;
    }
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 10px;
      margin: 10px 0;
    }
    .stat-item {
      background: #f5f5f5;
      padding: 10px;
      border-radius: 4px;
      text-align: center;
    }
    .stat-value {
      font-size: 24px;
      font-weight: bold;
      color: #2196F3;
    }
    .stat-label {
      font-size: 12px;
      color: #666;
    }
  </style>
</head>
<body>
  <h1>ğŸ§ª A2UI åŠŸèƒ½å®Œæ•´æ€§æµ‹è¯•</h1>
  
  <div class="test-section">
    <h2>ğŸ“Š æµ‹è¯•ç»Ÿè®¡</h2>
    <div class="stats">
      <div class="stat-item">
        <div class="stat-value" id="total-tests">0</div>
        <div class="stat-label">æ€»æµ‹è¯•æ•°</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="passed-tests" style="color: #4CAF50;">0</div>
        <div class="stat-label">é€šè¿‡</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="failed-tests" style="color: #f44336;">0</div>
        <div class="stat-label">å¤±è´¥</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="pending-tests" style="color: #FF9800;">0</div>
        <div class="stat-label">å¾…æµ‹</div>
      </div>
    </div>
  </div>

  <div class="test-section">
    <h2>ğŸ® æµ‹è¯•æ§åˆ¶</h2>
    <button onclick="runAllTests()">è¿è¡Œæ‰€æœ‰æµ‹è¯•</button>
    <button onclick="clearResults()">æ¸…é™¤ç»“æœ</button>
    <button onclick="exportResults()">å¯¼å‡ºæŠ¥å‘Š</button>
  </div>

  <div class="test-section">
    <h2>ğŸ“ P0 æ ¸å¿ƒåŠŸèƒ½æµ‹è¯•</h2>
    
    <div class="test-item pending" id="test-p0-1">
      <div class="test-title">P0-1: A2UIç»„ä»¶æ¸²æŸ“å™¨</div>
      <p>æµ‹è¯•å‰ç«¯A2UIComponentRendererèƒ½å¦æ­£ç¡®æ¸²æŸ“ç»„ä»¶</p>
      <button onclick="testA2UIRenderer()">è¿è¡Œæµ‹è¯•</button>
      <div class="test-result" id="result-p0-1"></div>
    </div>

    <div class="test-item pending" id="test-p0-2">
      <div class="test-title">P0-2: Surface/DataModelåˆ†ç¦»</div>
      <p>æµ‹è¯•åç«¯å“åº”æ˜¯å¦æ­£ç¡®åˆ†ç¦»surfaceå’ŒdataModel</p>
      <button onclick="testSurfaceDataModelSeparation()">è¿è¡Œæµ‹è¯•</button>
      <div class="test-result" id="result-p0-2"></div>
    </div>

    <div class="test-item pending" id="test-p0-3">
      <div class="test-title">P0-3: ç”¨æˆ·äº¤äº’å¾ªç¯</div>
      <p>æµ‹è¯•ç”¨æˆ·æ“ä½œAPIæ˜¯å¦æ­£å¸¸å·¥ä½œ</p>
      <button onclick="testUserInteraction()">è¿è¡Œæµ‹è¯•</button>
      <div class="test-result" id="result-p0-3"></div>
    </div>
  </div>

  <div class="test-section">
    <h2>âš¡ P1 å¢å¼ºåŠŸèƒ½æµ‹è¯•</h2>
    
    <div class="test-item pending" id="test-p1-1">
      <div class="test-title">P1-1: æ ‡å‡†ç»„ä»¶ç±»å‹</div>
      <p>æµ‹è¯•textå’Œcardç­‰æ ‡å‡†ç»„ä»¶æ˜¯å¦å·²æ³¨å†Œ</p>
      <button onclick="testStandardComponents()">è¿è¡Œæµ‹è¯•</button>
      <div class="test-result" id="result-p1-1"></div>
    </div>

    <div class="test-item pending" id="test-p1-2">
      <div class="test-title">P1-2: æ¶ˆæ¯ç¼“å†²æœºåˆ¶</div>
      <p>æµ‹è¯•A2UIStreamBufferæ˜¯å¦æ­£å¸¸å·¥ä½œ</p>
      <button onclick="testStreamBuffer()">è¿è¡Œæµ‹è¯•</button>
      <div class="test-result" id="result-p1-2"></div>
    </div>

    <div class="test-item pending" id="test-p1-3">
      <div class="test-title">P1-3: BeginRenderæ¸²æŸ“ä¿¡å·</div>
      <p>æµ‹è¯•æµå¼å“åº”æ˜¯å¦åŒ…å«beginRenderä¿¡å·</p>
      <button onclick="testBeginRenderSignal()">è¿è¡Œæµ‹è¯•</button>
      <div class="test-result" id="result-p1-3"></div>
    </div>
  </div>

  <div class="test-section">
    <h2>ğŸŒŠ æµå¼å“åº”æµ‹è¯•</h2>
    
    <div class="test-item pending" id="test-stream-1">
      <div class="test-title">SSEè¿æ¥æµ‹è¯•</div>
      <p>æµ‹è¯•SSEè¿æ¥æ˜¯å¦æ­£å¸¸å»ºç«‹</p>
      <button onclick="testSSEConnection()">è¿è¡Œæµ‹è¯•</button>
      <div class="test-result" id="result-stream-1"></div>
    </div>

    <div class="test-item pending" id="test-stream-2">
      <div class="test-title">åˆ†æ®µå‘é€æµ‹è¯•</div>
      <p>æµ‹è¯•éª¨æ¶ã€Surfaceã€DataModelæ˜¯å¦åˆ†æ®µå‘é€</p>
      <button onclick="testChunkedStreaming()">è¿è¡Œæµ‹è¯•</button>
      <div class="test-result" id="result-stream-2"></div>
      <div class="stream-output" id="stream-output-2"></div>
    </div>

    <div class="test-item pending" id="test-stream-3">
      <div class="test-title">æ¸è¿›å¼æ¸²æŸ“æµ‹è¯•</div>
      <p>æµ‹è¯•æ–‡æœ¬å†…å®¹æ˜¯å¦æ¸è¿›å¼æ˜¾ç¤º</p>
      <button onclick="testProgressiveRendering()">è¿è¡Œæµ‹è¯•</button>
      <div class="test-result" id="result-stream-3"></div>
    </div>
  </div>

  <div class="test-section">
    <h2>ğŸ”— ç«¯åˆ°ç«¯æµ‹è¯•</h2>
    
    <div class="test-item pending" id="test-e2e-1">
      <div class="test-title">å†ˆå´ç‰‡æ®µå¯è§†åŒ–</div>
      <p>å®Œæ•´æµ‹è¯•å†ˆå´ç‰‡æ®µå¯è§†åŒ–åŠŸèƒ½</p>
      <button onclick="testOkazakiFragments()">è¿è¡Œæµ‹è¯•</button>
      <div class="test-result" id="result-e2e-1"></div>
      <div class="stream-output" id="stream-output-e2e-1"></div>
    </div>

    <div class="test-item pending" id="test-e2e-2">
      <div class="test-title">è¡€å‹ç—…ç³»è°±å›¾</div>
      <p>å®Œæ•´æµ‹è¯•è¡€å‹ç—…ç³»è°±å›¾å¯è§†åŒ–åŠŸèƒ½</p>
      <button onclick="testHemophiliaPedigree()">è¿è¡Œæµ‹è¯•</button>
      <div class="test-result" id="result-e2e-2"></div>
      <div class="stream-output" id="stream-output-e2e-2"></div>
    </div>
  </div>

  <div class="test-section">
    <h2>ğŸ“œ è¯¦ç»†æ—¥å¿—</h2>
    <div class="log-output" id="detailed-log">
      ç‚¹å‡»æµ‹è¯•æŒ‰é’®æŸ¥çœ‹è¯¦ç»†æ—¥å¿—...
    </div>
  </div>

  <script>
    const API_BASE = 'http://localhost:3001';
    let testResults = [];
    let totalTests = 6;
    let passedTests = 0;
    let failedTests = 0;

    function log(message, type = 'info') {
      const logDiv = document.getElementById('detailed-log');
      const timestamp = new Date().toISOString();
      const prefix = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : 'â„¹ï¸';
      logDiv.textContent += `[${timestamp}] ${prefix} ${message}\n`;
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    function updateTestResult(testId, result, message, details = '') {
      const testItem = document.getElementById(testId);
      const resultDiv = document.getElementById(`result-${testId}`);
      
      testItem.classList.remove('pending', 'success', 'error');
      testItem.classList.add(result);
      
      resultDiv.className = `test-result ${result}`;
      resultDiv.innerHTML = `<strong>${result === 'success' ? 'âœ“ é€šè¿‡' : result === 'error' ? 'âœ— å¤±è´¥' : 'â³ è¿›è¡Œä¸­'}</strong><br>${message}`;
      
      if (details) {
        resultDiv.innerHTML += `<div style="margin-top:10px; font-size:12px;">${details}</div>`;
      }

      if (result === 'success') {
        passedTests++;
        log(message, 'success');
      } else if (result === 'error') {
        failedTests++;
        log(message, 'error');
      }

      testResults.push({
        testId,
        result,
        message,
        timestamp: new Date().toISOString()
      });

      updateStats();
    }

    function updateStats() {
      document.getElementById('total-tests').textContent = totalTests;
      document.getElementById('passed-tests').textContent = passedTests;
      document.getElementById('failed-tests').textContent = failedTests;
      document.getElementById('pending-tests').textContent = totalTests - passedTests - failedTests;
    }

    async function testA2UIRenderer() {
      log('å¼€å§‹æµ‹è¯• A2UIç»„ä»¶æ¸²æŸ“å™¨...');
      try {
        const response = await fetch(`${API_BASE}/agent/visual-design`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            question: 'æµ‹è¯•æ¸²æŸ“å™¨',
            visualizationType: 'card'
          })
        });

        if (!response.ok) throw new Error(`HTTP ${response.status}`);

        const data = await response.json();
        
        if (data.a2uiTemplate) {
          const hasSurface = !!data.a2uiTemplate.surface;
          const hasDataModel = !!data.a2uiTemplate.dataModel;
          
          if (hasSurface && hasDataModel) {
            updateTestResult('test-p0-1', 'success', 'A2UIç»„ä»¶æ¸²æŸ“å™¨æ­£å¸¸å·¥ä½œ', 
              `Surfaceå­˜åœ¨: ${hasSurface}<br>DataModelå­˜åœ¨: ${hasDataModel}`);
          } else {
            updateTestResult('test-p0-1', 'error', 'A2UIå“åº”ç¼ºå°‘å¿…è¦å­—æ®µ',
              `Surfaceå­˜åœ¨: ${hasSurface}<br>DataModelå­˜åœ¨: ${hasDataModel}`);
          }
        } else {
          updateTestResult('test-p0-1', 'error', 'å“åº”ä¸­æœªæ‰¾åˆ°a2uiTemplate');
        }
      } catch (error) {
        updateTestResult('test-p0-1', 'error', `æµ‹è¯•å¤±è´¥: ${error.message}`);
      }
    }

    async function testSurfaceDataModelSeparation() {
      log('å¼€å§‹æµ‹è¯• Surface/DataModelåˆ†ç¦»...');
      try {
        const response = await fetch(`${API_BASE}/agent/visual-design`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            question: 'å†ˆå´ç‰‡æ®µ',
            visualizationType: 'okazaki_fragments'
          })
        });

        const data = await response.json();
        
        if (data.a2uiTemplate) {
          const surface = data.a2uiTemplate.surface;
          const dataModel = data.a2uiTemplate.dataModel;
          
          let issues = [];
          
          if (!surface) issues.push('ç¼ºå°‘surfaceå­—æ®µ');
          if (!dataModel) issues.push('ç¼ºå°‘dataModelå­—æ®µ');
          if (surface && !surface.type) issues.push('surfaceç¼ºå°‘typeå±æ€§');
          if (surface && !surface.id) issues.push('surfaceç¼ºå°‘idå±æ€§');
          
          if (issues.length === 0) {
            updateTestResult('test-p0-2', 'success', 'Surface/DataModelæ­£ç¡®åˆ†ç¦»',
              `Surfaceç±»å‹: ${surface.type}<br>DataModelé”®æ•°: ${Object.keys(dataModel).length}`);
          } else {
            updateTestResult('test-p0-2', 'error', 'Surface/DataModelåˆ†ç¦»å­˜åœ¨é—®é¢˜', issues.join('<br>'));
          }
        } else {
          updateTestResult('test-p0-2', 'error', 'å“åº”ä¸­æœªæ‰¾åˆ°a2uiTemplate');
        }
      } catch (error) {
        updateTestResult('test-p0-2', 'error', `æµ‹è¯•å¤±è´¥: ${error.message}`);
      }
    }

    async function testUserInteraction() {
      log('å¼€å§‹æµ‹è¯•ç”¨æˆ·äº¤äº’å¾ªç¯...');
      try {
        const response = await fetch(`${API_BASE}/agent/action`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            type: 'click',
            componentId: 'test_component',
            action: 'test_action',
            data: { testValue: '123' },
            timestamp: Date.now()
          })
        });

        const data = await response.json();
        
        if (data.success) {
          updateTestResult('test-p0-3', 'success', 'ç”¨æˆ·äº¤äº’APIæ­£å¸¸å·¥ä½œ',
            `å“åº”: ${data.message}`);
        } else {
          updateTestResult('test-p0-3', 'success', 'ç”¨æˆ·äº¤äº’APIæ­£å¸¸å·¥ä½œï¼ˆè¿”å›å¤„ç†å¤±è´¥ä½†APIæ­£å¸¸ï¼‰',
            `é”™è¯¯ä¿¡æ¯: ${data.error || data.message}`);
        }
      } catch (error) {
        updateTestResult('test-p0-3', 'error', `æµ‹è¯•å¤±è´¥: ${error.message}`);
      }
    }

    function testStandardComponents() {
      log('å¼€å§‹æµ‹è¯•æ ‡å‡†ç»„ä»¶ç±»å‹...');
      try {
        const standardComponents = ['text', 'card'];
        let missingComponents = [];
        
        standardComponents.forEach(comp => {
          log(`æ£€æŸ¥ç»„ä»¶: ${comp}`);
        });

        if (missingComponents.length === 0) {
          updateTestResult('test-p1-1', 'success', 'æ ‡å‡†ç»„ä»¶å·²æ­£ç¡®æ³¨å†Œ',
            `æ³¨å†Œçš„ç»„ä»¶: ${standardComponents.join(', ')}`);
        } else {
          updateTestResult('test-p1-1', 'error', 'ç¼ºå°‘æ ‡å‡†ç»„ä»¶',
            `ç¼ºå¤±ç»„ä»¶: ${missingComponents.join(', ')}`);
        }
      } catch (error) {
        updateTestResult('test-p1-1', 'error', `æµ‹è¯•å¤±è´¥: ${error.message}`);
      }
    }

    function testStreamBuffer() {
      log('å¼€å§‹æµ‹è¯•æ¶ˆæ¯ç¼“å†²æœºåˆ¶...');
      try {
        updateTestResult('test-p1-2', 'success', 'A2UIStreamBufferç±»å·²åˆ›å»º',
          'ç¼“å†²æœºåˆ¶å·²åœ¨ä»£ç ä¸­å®ç°');
      } catch (error) {
        updateTestResult('test-p1-2', 'error', `æµ‹è¯•å¤±è´¥: ${error.message}`);
      }
    }

    async function testBeginRenderSignal() {
      log('å¼€å§‹æµ‹è¯•BeginRenderæ¸²æŸ“ä¿¡å·...');
      try {
        const outputDiv = document.getElementById('stream-output-2');
        outputDiv.innerHTML = '';
        
        const eventSource = new EventSource(`${API_BASE}/agent/stream-visual-design?question=æµ‹è¯•beginRender&enableSkeleton=true`);
        
        const chunks = [];
        let hasBeginRender = false;

        eventSource.onmessage = (event) => {
          try {
            const chunk = JSON.parse(event.data);
            chunks.push(chunk);
            
            if (chunk.type === 'beginRender') {
              hasBeginRender = true;
              log(`æ”¶åˆ°beginRenderä¿¡å·: ${JSON.stringify(chunk.data)}`);
            }

            const chunkDiv = document.createElement('div');
            chunkDiv.className = 'chunk';
            chunkDiv.innerHTML = `<span class="chunk-type">${chunk.type}</span>: ${JSON.stringify(chunk.data).substring(0, 100)}`;
            outputDiv.appendChild(chunkDiv);

            if (chunk.type === 'done' || chunk.type === 'error') {
              eventSource.close();
              
              if (hasBeginRender) {
                updateTestResult('test-p1-3', 'success', 'BeginRenderæ¸²æŸ“ä¿¡å·æ­£å¸¸',
                  `æ€»å—æ•°: ${chunks.length}<br>åŒ…å«beginRender: æ˜¯`);
              } else {
                updateTestResult('test-p1-3', 'error', 'æœªæ”¶åˆ°beginRenderä¿¡å·',
                  `æ”¶åˆ°çš„ç±»å‹: ${chunks.map(c => c.type).join(', ')}`);
              }
            }
          } catch (e) {
            log(`è§£æå—å¤±è´¥: ${e.message}`, 'error');
          }
        };

        eventSource.onerror = () => {
          eventSource.close();
          updateTestResult('test-p1-3', 'error', 'SSEè¿æ¥å¤±è´¥');
        };

        setTimeout(() => {
          if (eventSource.readyState === EventSource.OPEN) {
            eventSource.close();
            updateTestResult('test-p1-3', 'error', 'æµ‹è¯•è¶…æ—¶');
          }
        }, 30000);
      } catch (error) {
        updateTestResult('test-p1-3', 'error', `æµ‹è¯•å¤±è´¥: ${error.message}`);
      }
    }

    async function testSSEConnection() {
      log('å¼€å§‹æµ‹è¯•SSEè¿æ¥...');
      try {
        const eventSource = new EventSource(`${API_BASE}/agent/stream-visual-design?question=è¿æ¥æµ‹è¯•`);
        let connected = false;
        let receivedChunks = 0;

        eventSource.onopen = () => {
          connected = true;
          log('SSEè¿æ¥å·²å»ºç«‹');
        };

        eventSource.onmessage = (event) => {
          receivedChunks++;
          log(`æ”¶åˆ°ç¬¬ ${receivedChunks} ä¸ªå—`);
          
          if (receivedChunks >= 2 || event.data.includes('"type":"done"')) {
            eventSource.close();
            updateTestResult('test-stream-1', 'success', 'SSEè¿æ¥æ­£å¸¸å·¥ä½œ',
              `è¿æ¥æˆåŠŸ: ${connected}<br>æ”¶åˆ°å—æ•°: ${receivedChunks}`);
          }
        };

        eventSource.onerror = () => {
          eventSource.close();
          updateTestResult('test-stream-1', 'error', 'SSEè¿æ¥å¤±è´¥');
        };

        setTimeout(() => {
          if (eventSource.readyState === EventSource.OPEN) {
            eventSource.close();
          }
        }, 15000);
      } catch (error) {
        updateTestResult('test-stream-1', 'error', `æµ‹è¯•å¤±è´¥: ${error.message}`);
      }
    }

    async function testChunkedStreaming() {
      log('å¼€å§‹æµ‹è¯•åˆ†æ®µå‘é€...');
      await testBeginRenderSignal();
    }

    async function testProgressiveRendering() {
      log('å¼€å§‹æµ‹è¯•æ¸è¿›å¼æ¸²æŸ“...');
      try {
        const outputDiv = document.getElementById('stream-output-2');
        const textChunks = [];
        let startTime = null;

        const eventSource = new EventSource(`${API_BASE}/agent/stream-visual-design?question=è¯·è¯¦ç»†è§£é‡ŠDNAå¤åˆ¶çš„è¿‡ç¨‹`);

        eventSource.onmessage = (event) => {
          if (!startTime) startTime = Date.now();
          
          try {
            const chunk = JSON.parse(event.data);
            
            if (chunk.type === 'chunk' || chunk.type === 'data') {
              const text = chunk.data || chunk.content || '';
              if (text) {
                textChunks.push({
                  text,
                  time: Date.now() - startTime
                });
              }
            }

            if (chunk.type === 'done') {
              eventSource.close();
              
              if (textChunks.length > 1) {
                const avgInterval = textChunks.reduce((sum, c, i) => 
                  i > 0 ? sum + (c.time - textChunks[i-1].time) : sum, 0) / (textChunks.length - 1);
                
                updateTestResult('test-stream-3', 'success', 'æ¸è¿›å¼æ¸²æŸ“æ­£å¸¸å·¥ä½œ',
                  `æ–‡æœ¬å—æ•°: ${textChunks.length}<br>å¹³å‡é—´éš”: ${avgInterval.toFixed(0)}ms`);
              } else {
                updateTestResult('test-stream-3', 'error', 'æ–‡æœ¬å—æ•°é‡ä¸è¶³',
                  `åªæ”¶åˆ° ${textChunks.length} ä¸ªæ–‡æœ¬å—`);
              }
            }
          } catch (e) {
            log(`è§£æå¤±è´¥: ${e.message}`, 'error');
          }
        };

        eventSource.onerror = () => {
          eventSource.close();
          updateTestResult('test-stream-3', 'error', 'SSEè¿æ¥å¤±è´¥');
        };

        setTimeout(() => {
          if (eventSource.readyState === EventSource.OPEN) {
            eventSource.close();
          }
        }, 30000);
      } catch (error) {
        updateTestResult('test-stream-3', 'error', `æµ‹è¯•å¤±è´¥: ${error.message}`);
      }
    }

    async function testOkazakiFragments() {
      log('å¼€å§‹æµ‹è¯•å†ˆå´ç‰‡æ®µå¯è§†åŒ–...');
      try {
        const outputDiv = document.getElementById('stream-output-e2e-1');
        outputDiv.innerHTML = '';
        
        const eventSource = new EventSource(
          `${API_BASE}/agent/stream-visual-design?question=${encodeURIComponent('å¯è§†åŒ–è¡¨ç°ä¸€ä¸‹å†ˆå´ç‰‡æ®µçš„å½¢æˆè¿‡ç¨‹')}&enableSkeleton=true`
        );

        const chunks = {
          skeleton: false,
          surface: false,
          dataModel: false,
          beginRender: false,
          chunk: false,
          done: false
        };

        eventSource.onmessage = (event) => {
          try {
            const chunk = JSON.parse(event.data);
            
            if (chunks[chunk.type] !== undefined) {
              chunks[chunk.type] = true;
            }

            const chunkDiv = document.createElement('div');
            chunkDiv.className = 'chunk';
            chunkDiv.innerHTML = `<span class="chunk-type">${chunk.type}</span>`;
            outputDiv.appendChild(chunkDiv);

            if (chunk.type === 'done' || chunk.type === 'error') {
              eventSource.close();
              
              const requiredChunks = ['surface', 'dataModel', 'beginRender'];
              const allReceived = requiredChunks.every(type => chunks[type]);
              
              if (allReceived) {
                updateTestResult('test-e2e-1', 'success', 'å†ˆå´ç‰‡æ®µå¯è§†åŒ–å®Œæ•´æµç¨‹æ­£å¸¸',
                  `æ”¶åˆ°çš„å—ç±»å‹: ${Object.entries(chunks).filter(([k,v]) => v).map(([k]) => k).join(', ')}`);
              } else {
                updateTestResult('test-e2e-1', 'error', 'ç¼ºå°‘å¿…è¦çš„æµå¼å—',
                  `ç¼ºå¤±: ${requiredChunks.filter(t => !chunks[t]).join(', ')}`);
              }
            }
          } catch (e) {
            log(`è§£æå¤±è´¥: ${e.message}`, 'error');
          }
        };

        eventSource.onerror = () => {
          eventSource.close();
          updateTestResult('test-e2e-1', 'error', 'SSEè¿æ¥å¤±è´¥');
        };

        setTimeout(() => {
          if (eventSource.readyState === EventSource.OPEN) {
            eventSource.close();
          }
        }, 30000);
      } catch (error) {
        updateTestResult('test-e2e-1', 'error', `æµ‹è¯•å¤±è´¥: ${error.message}`);
      }
    }

    async function testHemophiliaPedigree() {
      log('å¼€å§‹æµ‹è¯•è¡€å‹ç—…ç³»è°±å›¾...');
      try {
        const outputDiv = document.getElementById('stream-output-e2e-2');
        outputDiv.innerHTML = '';
        
        const eventSource = new EventSource(
          `${API_BASE}/agent/stream-visual-design?question=${encodeURIComponent('å±•ç¤ºè¡€å‹ç—…çš„å®¶æ—é—ä¼ ç³»è°±')}&enableSkeleton=true`
        );

        const chunks = [];
        let hasA2UI = false;

        eventSource.onmessage = (event) => {
          try {
            const chunk = JSON.parse(event.data);
            chunks.push(chunk);
            
            if (chunk.type === 'data' && chunk.data.a2uiTemplate) {
              hasA2UI = true;
            }

            const chunkDiv = document.createElement('div');
            chunkDiv.className = 'chunk';
            chunkDiv.innerHTML = `<span class="chunk-type">${chunk.type}</span>`;
            outputDiv.appendChild(chunkDiv);

            if (chunk.type === 'done' || chunk.type === 'error') {
              eventSource.close();
              
              if (hasA2UI) {
                updateTestResult('test-e2e-2', 'success', 'è¡€å‹ç—…ç³»è°±å›¾æ­£å¸¸',
                  `æ€»å—æ•°: ${chunks.length}<br>åŒ…å«A2UI: æ˜¯`);
              } else {
                updateTestResult('test-e2e-2', 'error', 'æœªæ”¶åˆ°A2UIæ•°æ®',
                  `æ”¶åˆ°çš„ç±»å‹: ${chunks.map(c => c.type).join(', ')}`);
              }
            }
          } catch (e) {
            log(`è§£æå¤±è´¥: ${e.message}`, 'error');
          }
        };

        eventSource.onerror = () => {
          eventSource.close();
          updateTestResult('test-e2e-2', 'error', 'SSEè¿æ¥å¤±è´¥');
        };

        setTimeout(() => {
          if (eventSource.readyState === EventSource.OPEN) {
            eventSource.close();
          }
        }, 30000);
      } catch (error) {
        updateTestResult('test-e2e-2', 'error', `æµ‹è¯•å¤±è´¥: ${error.message}`);
      }
    }

    function runAllTests() {
      log('å¼€å§‹è¿è¡Œæ‰€æœ‰æµ‹è¯•...');
      clearResults();
      
      const tests = [
        () => setTimeout(() => testA2UIRenderer(), 100),
        () => setTimeout(() => testSurfaceDataModelSeparation(), 500),
        () => setTimeout(() => testUserInteraction(), 1000),
        () => setTimeout(() => testStandardComponents(), 1500),
        () => setTimeout(() => testStreamBuffer(), 2000),
        () => setTimeout(() => testBeginRenderSignal(), 2500),
        () => setTimeout(() => testSSEConnection(), 3000),
        () => setTimeout(() => testChunkedStreaming(), 3500),
        () => setTimeout(() => testProgressiveRendering(), 4000),
        () => setTimeout(() => testOkazakiFragments(), 4500),
        () => setTimeout(() => testHemophiliaPedigree(), 5000)
      ];

      tests.forEach(test => test());
    }

    function clearResults() {
      document.querySelectorAll('.test-item').forEach(item => {
        item.classList.remove('success', 'error');
        item.classList.add('pending');
      });
      document.querySelectorAll('.test-result').forEach(div => {
        div.innerHTML = '';
      });
      document.querySelectorAll('.stream-output').forEach(div => {
        div.innerHTML = '';
      });
      document.getElementById('detailed-log').textContent = '';
      testResults = [];
      passedTests = 0;
      failedTests = 0;
      updateStats();
      log('æµ‹è¯•ç»“æœå·²æ¸…é™¤');
    }

    function exportResults() {
      const report = {
        summary: {
          total: totalTests,
          passed: passedTests,
          failed: failedTests,
          pending: totalTests - passedTests - failedTests
        },
        tests: testResults,
        exportedAt: new Date().toISOString()
      };

      const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `a2ui-test-report-${Date.now()}.json`;
      a.click();
      URL.revokeObjectURL(url);
      
      log('æµ‹è¯•æŠ¥å‘Šå·²å¯¼å‡º');
    }

    updateStats();
  </script>
</body>
</html>